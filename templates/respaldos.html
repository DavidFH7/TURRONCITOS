{% extends "base.html" %}

{% block title %}Gestión de Respaldo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-database me-2"></i>Gestión de Respaldo</h2>
            <div>
                <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#importarModal">
                    <i class="fas fa-upload me-2"></i>Importar Respaldo
                </button>
                <form action="{{ url_for('eliminar_todos_respaldos') }}" method="post" class="d-inline" onsubmit="return confirm('¿Seguro que deseas eliminar TODOS los respaldos? Esta acción no se puede deshacer.');">
                    <button type="submit" class="btn btn-danger me-2">
                        <i class="fas fa-trash-alt me-2"></i>Eliminar Todos
                    </button>
                </form>
                <a href="{{ url_for('crear_respaldo_manual') }}" class="btn btn-success me-2">
                    <i class="fas fa-plus me-2"></i>Crear Respaldo
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Información sobre respaldos -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>Información sobre Respaldo</h5>
            <p class="mb-2">Los respaldos se crean automáticamente al iniciar el programa y manualmente cuando lo solicites.</p>
            <ul class="mb-0">
                <li><strong>Respaldo automático:</strong> Se crea cada vez que inicias el programa</li>
                <li><strong>Respaldo manual:</strong> Puedes crear respaldos en cualquier momento</li>
                <li><strong>Restaurar:</strong> Puedes restaurar desde cualquier respaldo disponible</li>
                <li><strong>Descargar:</strong> Puedes descargar respaldos para guardarlos externamente</li>
            </ul>
        </div>
    </div>
</div>

<!-- Lista de respaldos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Respaldo Disponibles</h5>
            </div>
            <div class="card-body">
                {% if respaldos %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre del Archivo</th>
                                <th>Carpeta</th>
                                <th>Fecha de Creación</th>
                                <th>Tamaño</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for respaldo in respaldos %}
                            <tr>
                                <td>
                                    <i class="fas fa-database text-primary me-2"></i>
                                    <strong>{{ respaldo.nombre }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-folder me-1"></i>{{ respaldo.carpeta }}
                                    </span>
                                </td>
                                <td>{{ respaldo.fecha_formateada }}</td>
                                <td>
                                    {% if respaldo.tamaño > 1024*1024 %}
                                        {{ "%.1f"|format(respaldo.tamaño / (1024*1024)) }} MB
                                    {% elif respaldo.tamaño > 1024 %}
                                        {{ "%.1f"|format(respaldo.tamaño / 1024) }} KB
                                    {% else %}
                                        {{ respaldo.tamaño }} bytes
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('restaurar_respaldo', filename=respaldo.ruta_relativa) }}" 
                                           class="btn btn-warning btn-sm" 
                                           onclick="return confirm('¿Estás seguro de que quieres restaurar desde este respaldo?\\n\\nEsta acción reemplazará la base de datos actual con los datos del respaldo seleccionado.\\n\\nDespués de restaurar, serás redirigido al dashboard para ver los datos restaurados.')">
                                            <i class="fas fa-undo me-1"></i>Restaurar
                                        </a>
                                        <a href="{{ url_for('descargar_respaldo', filename=respaldo.ruta_relativa) }}" 
                                           class="btn btn-info btn-sm">
                                            <i class="fas fa-download me-1"></i>Descargar
                                        </a>
                                        <a href="{{ url_for('eliminar_respaldo', filename=respaldo.ruta_relativa) }}" 
                                           class="btn btn-danger btn-sm" 
                                           onclick="return confirm('¿Estás seguro de que quieres eliminar este respaldo?')">
                                            <i class="fas fa-trash me-1"></i>Eliminar
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No hay respaldos disponibles</h4>
                    <p class="text-muted">Crea tu primer respaldo para proteger tus datos</p>
                    <a href="{{ url_for('crear_respaldo_manual') }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Crear Primer Respaldo
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas de respaldos -->
{% if respaldos %}
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-database fa-2x mb-2"></i>
                <h3>{{ respaldos|length }}</h3>
                <p class="mb-0">Total de Respaldo</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h3>{{ respaldos[0].fecha_formateada if respaldos else 'N/A' }}</h3>
                <p class="mb-0">Último Respaldo</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-hdd fa-2x mb-2"></i>
                <h3>
                    {% set total_size = respaldos|sum(attribute='tamaño') %}
                    {% if total_size > 1024*1024 %}
                        {{ "%.1f"|format(total_size / (1024*1024)) }} MB
                    {% elif total_size > 1024 %}
                        {{ "%.1f"|format(total_size / 1024) }} KB
                    {% else %}
                        {{ total_size }} bytes
                    {% endif %}
                </h3>
                <p class="mb-0">Espacio Total</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Instrucciones -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>¿Cómo usar los respaldos?</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-plus-circle text-success me-2"></i>Crear Respaldo</h6>
                        <p class="text-muted">Haz clic en "Crear Respaldo" para hacer una copia manual de tu base de datos actual.</p>
                        
                        <h6><i class="fas fa-undo text-warning me-2"></i>Restaurar</h6>
                        <p class="text-muted">Selecciona un respaldo y haz clic en "Restaurar" para volver a ese estado. Esta acción reemplazará la base de datos actual. <strong>Después de restaurar, serás redirigido al dashboard para ver los datos restaurados.</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-download text-info me-2"></i>Descargar</h6>
                        <p class="text-muted">Descarga respaldos para guardarlos en tu computadora o en la nube como copia de seguridad externa.</p>
                        
                        <h6><i class="fas fa-trash text-danger me-2"></i>Eliminar</h6>
                        <p class="text-muted">Elimina respaldos antiguos para liberar espacio en disco. Ten cuidado, esta acción no se puede deshacer.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Importar Respaldo -->
<div class="modal fade" id="importarModal" tabindex="-1" aria-labelledby="importarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importarModalLabel">
                    <i class="fas fa-upload me-2"></i>Importar Respaldo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('importar_respaldo') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Se creará un respaldo de seguridad de la base de datos actual antes de importar el nuevo respaldo.
                    </div>
                    
                    <div class="mb-3">
                        <label for="backup_file" class="form-label">
                            <i class="fas fa-file-database me-2"></i>Seleccionar Archivo de Respaldo
                        </label>
                        <input type="file" class="form-control" id="backup_file" name="backup_file" accept=".db" required>
                        <div class="form-text">Solo se permiten archivos de base de datos (.db)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="backup_name" class="form-label">
                            <i class="fas fa-tag me-2"></i>Nombre Personalizado (Opcional)
                        </label>
                        <input type="text" class="form-control" id="backup_name" name="backup_name" placeholder="Dejar vacío para usar el nombre original">
                        <div class="form-text">Si no se especifica, se usará el nombre del archivo original</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> Esta acción reemplazará la base de datos actual. Asegúrate de tener un respaldo de seguridad.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Importar Respaldo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
